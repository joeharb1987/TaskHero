<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TaskHero - Task & Reward Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <!-- Firebase CDN SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
  <style>
    /* Your existing CSS remains unchanged - omitted here for brevity */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      color: #333;
      overflow-x: hidden;
    }
    /* Rest of your CSS... */
  </style>
</head>
<body>
  <!-- Your existing HTML body remains unchanged - omitted here for brevity -->
  <div id="app">
    <header>
      <div class="datetime" id="current-datetime"></div>
      <div class="profile">
        <img id="header-profile-pic" src="https://via.placeholder.com/40" alt="Profile">
        <select id="childSelect" aria-label="Select Child Profile"></select>
        <span class="stars"><i class="fas fa-star"></i> <span id="starCount">0</span></span>
      </div>
      <div class="progress-bar">
        <div class="progress" id="starProgress"></div>
      </div>
    </header>
    <!-- Rest of your HTML... -->
  </div>

  <script>
    // Initialize Firebase with your config
    const firebaseConfig = {
      apiKey: "AIzaSyDOx1nWxDLs3nWCXLxc_m67D-HsvvUjeIs",
      authDomain: "taskhero-2d52d.firebaseapp.com",
      projectId: "taskhero-2d52d",
      storageBucket: "taskhero-2d52d.firebasestorage.app",
      messagingSenderId: "526189020456",
      appId: "1:526189020456:web:cc88c782be3c84467cbc1d",
      measurementId: "G-JEZMT4PKPL"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    class Child {
      constructor(name, tasks = [], stars = 0, rewards = [], lastReset = null, photo = null, dob = null) {
        this.name = name;
        this.tasks = tasks.map(task => ({
          ...task,
          timerRemaining: task.timer ? task.timer * 60 : null,
          timerInterval: null,
          category: task.category || '',
          subtasks: (task.subtasks || []).map(subtask => ({
            name: subtask.name,
            completed: subtask.completed || false,
            timer: subtask.timer || null,
            timerRemaining: subtask.timer ? subtask.timer * 60 : null,
            timerInterval: null
          }))
        }));
        this.stars = Number(stars) || 0;
        this.rewards = rewards;
        this.lastReset = lastReset || Date.now();
        this.photo = photo || 'https://via.placeholder.com/40';
        this.dob = dob;
      }

      async addTask(name, stars, day, timer = null, category = '', subtasks = []) {
        this.tasks.push({
          name,
          stars: stars || 0,
          day,
          completed: false,
          timer,
          timerRemaining: timer ? timer * 60 : null,
          timerInterval: null,
          category,
          subtasks: subtasks.map(subtask => ({
            name: subtask.name,
            completed: false,
            timer: subtask.timer || null,
            timerRemaining: subtask.timer ? subtask.timer * 60 : null,
            timerInterval: null
          }))
        });
        await this.save();
      }

      async editTask(index, name, stars, day, timer, category, subtasks) {
        const task = this.tasks[index];
        if (task) {
          task.name = name;
          task.stars = stars || 0;
          task.day = day;
          task.timer = timer;
          task.category = category || '';
          task.subtasks = subtasks.map(subtask => ({
            name: subtask.name,
            completed: subtask.completed || false,
            timer: subtask.timer || null,
            timerRemaining: subtask.timer ? subtask.timer * 60 : null,
            timerInterval: null
          }));
          if (timer) {
            task.timerRemaining = timer * 60;
            if (task.timerInterval) clearInterval(task.timerInterval);
            task.timerInterval = null;
          } else {
            task.timerRemaining = null;
            if (task.timerInterval) clearInterval(task.timerInterval);
            task.timerInterval = null;
          }
          await this.save();
          updateTasks();
        }
      }

      async deleteTask(taskIndex) {
        const task = this.tasks[taskIndex];
        if (task && task.completed) this.stars -= task.stars;
        this.tasks.splice(taskIndex, 1);
        await this.save();
        updateTasks();
      }

      async moveSubtask(taskIndex, fromIndex, toIndex) {
        const task = this.tasks[taskIndex];
        if (task && task.subtasks && fromIndex >= 0 && toIndex >= 0 && fromIndex < task.subtasks.length && toIndex < task.subtasks.length) {
          const [subtask] = task.subtasks.splice(fromIndex, 1);
          task.subtasks.splice(toIndex, 0, subtask);
          await this.save();
          updateTasks();
        }
      }

      async addReward(name, stars, day) {
        this.rewards.push({ name, stars, day, claimed: false });
        await this.save();
      }

      async editReward(index, name, stars, day) {
        const reward = this.rewards[index];
        if (reward) {
          reward.name = name;
          reward.stars = stars;
          reward.day = day;
          await this.save();
          updateRewards();
        }
      }

      async deleteReward(index) {
        const reward = this.rewards[index];
        if (reward && reward.claimed) this.stars += reward.stars;
        this.rewards.splice(index, 1);
        await this.save();
        updateRewards();
      }

      toggleSubtask(taskIndex, subtaskIndex) {
        const task = this.tasks[taskIndex];
        if (task && task.subtasks[subtaskIndex] && !task.subtasks[subtaskIndex].timer) {
          task.subtasks[subtaskIndex].completed = !task.subtasks[subtaskIndex].completed;
          this.checkTaskCompletion(taskIndex);
        }
      }

      startSubtaskTimer(taskIndex, subtaskIndex) {
        const task = this.tasks[taskIndex];
        const subtask = task.subtasks[subtaskIndex];
        if (subtask && subtask.timer && !subtask.completed && subtask.timerRemaining > 0 && !subtask.timerInterval) {
          subtask.timerInterval = setInterval(async () => {
            subtask.timerRemaining--;
            const timerSpan = document.querySelector(`.subtask[data-task="${taskIndex}"][data-subtask="${subtaskIndex}"] .timer`);
            if (timerSpan) timerSpan.textContent = formatTime(subtask.timerRemaining);
            if (subtask.timerRemaining <= 0) {
              clearInterval(subtask.timerInterval);
              subtask.timerInterval = null;
              subtask.completed = true;
              this.checkTaskCompletion(taskIndex);
              await this.save();
              updateTasks();
            }
          }, 1000);
          this.save();
        }
      }

      async checkTaskCompletion(taskIndex) {
        const task = this.tasks[taskIndex];
        if (task.subtasks.length > 0) {
          const allSubtasksCompleted = task.subtasks.every(subtask => subtask.completed);
          if (allSubtasksCompleted && !task.completed) {
            task.completed = true;
            this.stars += task.stars;
          } else if (!allSubtasksCompleted && task.completed) {
            task.completed = false;
            this.stars = Math.max(0, this.stars - task.stars);
          }
        } else if (!task.timer) {
          task.completed = !task.completed;
          if (task.completed) this.stars += task.stars;
          else this.stars = Math.max(0, this.stars - task.stars);
        }
        await this.save();
        updateTasks();
        updateRewards();
        updateChildSelect();
      }

      startTaskTimer(taskIndex) {
        const task = this.tasks[taskIndex];
        if (task && task.timer && !task.completed && task.timerRemaining > 0 && !task.timerInterval) {
          task.timerInterval = setInterval(async () => {
            task.timerRemaining--;
            const timerSpan = document.querySelector(`.task[data-index="${taskIndex}"] .timer`);
            if (timerSpan) timerSpan.textContent = formatTime(task.timerRemaining);
            if (task.timerRemaining <= 0) {
              clearInterval(task.timerInterval);
              task.timerInterval = null;
              task.completed = true;
              this.stars += task.stars;
              await this.save();
              updateTasks();
            }
          }, 1000);
          this.save();
        }
      }

      async claimReward(index) {
        const reward = this.rewards[index];
        if (reward && !reward.claimed && this.stars >= reward.stars) {
          reward.claimed = true;
          this.stars -= reward.stars;
          await this.save();
          updateRewards();
          updateChildSelect();
        }
      }

      async resetRewards() {
        const now = Date.now();
        const today = new Date();
        const lastResetDate = new Date(this.lastReset);
        if (today.getDate() !== lastResetDate.getDate() || 
            today.getMonth() !== lastResetDate.getMonth() || 
            today.getFullYear() !== lastResetDate.getFullYear()) {
          this.rewards = this.rewards.map(reward => ({ ...reward, claimed: false }));
          this.lastReset = now;
          await this.save();
        }
      }

      async save() {
        const data = {
          tasks: this.tasks.map(task => ({
            ...task,
            timerInterval: null,
            subtasks: task.subtasks.map(subtask => ({
              ...subtask,
              timerInterval: null
            }))
          })),
          stars: this.stars,
          rewards: this.rewards,
          lastReset: this.lastReset,
          photo: this.photo,
          dob: this.dob
        };
        await db.collection('children').doc(this.name).set(data);
      }

      static async load(name) {
        const doc = await db.collection('children').doc(name).get();
        const data = doc.exists ? doc.data() : {
          tasks: [],
          stars: 0,
          rewards: [],
          lastReset: null,
          photo: null,
          dob: null
        };
        return new Child(name, data.tasks, data.stars, data.rewards, data.lastReset, data.photo, data.dob);
      }
    }

    let children = {};
    let currentChild = null;
    let currentDate = getCurrentDay();
    let editingItem = null;

    function getCurrentDay() {
      const now = new Date();
      const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
      return days[now.getDay()];
    }

    function updateDateTime() {
      const now = new Date();
      const dayName = now.toLocaleDateString('en-US', { weekday: 'short' });
      const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      document.getElementById('current-datetime').textContent = `${dayName}, ${dateStr}`;
    }

    function updateDateNav() {
      const days = ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'];
      document.querySelectorAll('.date-nav span').forEach((span, index) => {
        span.textContent = days[index].slice(0, 3);
        span.classList.toggle('active', days[index] === currentDate);
      });
    }

    async function loadInitialData() {
      const snapshot = await db.collection('children').get();
      if (snapshot.empty) {
        document.getElementById('welcome-screen').style.display = 'flex';
      } else {
        snapshot.forEach(doc => {
          const name = doc.id;
          const data = doc.data();
          children[name] = new Child(name, data.tasks, data.stars, data.rewards, data.lastReset, data.photo, data.dob);
          children[name].resetRewards();
        });
        currentChild = children[Object.keys(children)[0]];
        document.getElementById('app').style.display = 'block';
        updateDateNav();
        updateDateTime();
        updateChildSelect();
        updateTasks();
      }

      // Real-time listener for syncing
      db.collection('children').onSnapshot(snapshot => {
        snapshot.docChanges().forEach(change => {
          const name = change.doc.id;
          const data = change.doc.data();
          if (change.type === 'added' || change.type === 'modified') {
            children[name] = new Child(name, data.tasks, data.stars, data.rewards, data.lastReset, data.photo, data.dob);
          } else if (change.type === 'removed') {
            delete children[name];
          }
        });
        if (currentChild) {
          currentChild = children[currentChild.name] || Object.values(children)[0];
          updateChildSelect();
          updateTasks();
          updateRewards();
          updateProfiles();
        }
      }, error => {
        console.error("Firestore listener error:", error);
      });
    }

    function updateChildSelect() {
      const select = document.getElementById('childSelect');
      select.innerHTML = '';
      Object.keys(children).forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        select.appendChild(option);
      });
      const separator = document.createElement('option');
      separator.disabled = true;
      separator.textContent = '──────────';
      select.appendChild(separator);
      const editOption = document.createElement('option');
      editOption.value = 'edit-profiles';
      editOption.textContent = 'Edit/Add Profiles';
      select.appendChild(editOption);

      if (currentChild) {
        select.value = currentChild.name;
        document.getElementById('header-profile-pic').src = currentChild.photo;
        document.getElementById('starCount').textContent = currentChild.stars;
        updateProgressBar();
      }
    }

    function updateProgressBar() {
      const totalStars = currentChild ? currentChild.stars : 0;
      const maxStars = 100;
      document.getElementById('starProgress').style.width = `${(totalStars / maxStars) * 100}%`;
    }

    function setDate(day) {
      currentDate = day;
      updateDateNav();
      updateTasks();
      updateRewards();
    }

    function showSection(section) {
      document.querySelectorAll('#tasks, #rewards, #profiles').forEach(el => el.classList.remove('active'));
      document.getElementById(section).classList.add('active');
      document.querySelectorAll('.nav-tabs span').forEach(span => span.classList.remove('active'));
      document.querySelector(`.nav-tabs span[data-section="${section}"]`).classList.add('active');
      if (section === 'tasks') updateTasks();
      if (section === 'rewards') updateRewards();
      if (section === 'profiles') updateProfiles();
    }

    function formatTime(seconds) {
      const minutes = Math.floor(seconds / 60);
      const secs = seconds % 60;
      return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
    }

    function getTaskIcon(taskName) {
      const lowerName = taskName.toLowerCase();
      if (lowerName.includes('brush') || lowerName.includes('teeth')) return 'fas fa-tooth';
      if (lowerName.includes('bed')) return 'fas fa-bed';
      if (lowerName.includes('clothes')) return 'fas fa-tshirt';
      if (lowerName.includes('breakfast')) return 'fas fa-utensils';
      return 'fas fa-tasks';
    }

    function updateTasks() {
      if (!currentChild) return;
      const taskList = document.getElementById('task-list');
      taskList.innerHTML = '';
      const filteredTasks = currentChild.tasks
        .map((task, index) => ({ task, originalIndex: index }))
        .filter(({ task }) => task.day === currentDate);

      filteredTasks.forEach(({ task, originalIndex }) => {
        const taskDiv = document.createElement('div');
        taskDiv.className = `task ${task.completed ? 'completed' : ''}`;
        taskDiv.draggable = true;
        taskDiv.dataset.index = originalIndex;
        const icon = getTaskIcon(task.name);
        const categoryTag = task.category ? `<small class="category">[${task.category}]</small>` : '';
        const starsDisplay = task.stars === 0 ? '0 ⭐' : `(${task.stars} ⭐)`;

        let subtaskHTML = '';
        if (task.subtasks.length > 0) {
          subtaskHTML = '<div class="subtasks">';
          task.subtasks.forEach((subtask, subIndex) => {
            const timerDisplay = subtask.timerRemaining !== null ? `<span class="timer">${formatTime(subtask.timerRemaining)}</span>` : '';
            subtaskHTML += `
              <div class="subtask ${subtask.completed ? 'completed' : ''}" data-task="${originalIndex}" data-subtask="${subIndex}" draggable="true">
                <input type="checkbox" class="subtask-checkbox" data-task="${originalIndex}" data-subtask="${subIndex}" ${subtask.completed ? 'checked' : ''}>
                <span>${subtask.name}</span>
                ${subtask.timer ? `<button class="start" data-task="${originalIndex}" data-subtask="${subIndex}" ${subtask.completed || subtask.timerRemaining === null ? 'disabled' : ''}>Start</button>` : ''} ${timerDisplay}
              </div>`;
          });
          subtaskHTML += '</div>';
        }

        taskDiv.innerHTML = `
          <i class="task-icon ${icon}"></i>
          <span>${task.name} ${categoryTag} ${starsDisplay}</span>
          ${task.timer ? `<button class="start" data-index="${originalIndex}" ${task.completed || task.timerRemaining === null ? 'disabled' : ''}>Start</button>` : ''}${task.timer && task.timerRemaining !== null ? `<span class="timer">${formatTime(task.timerRemaining)}</span>` : ''}
          ${subtaskHTML}
        `;

        taskDiv.addEventListener('click', (e) => {
          if (e.target.classList.contains('subtask-checkbox') || e.target.classList.contains('start')) return;
          openEditModal('task', originalIndex);
        });
        taskList.appendChild(taskDiv);
      });

      const tasks = document.querySelectorAll('.task');
      tasks.forEach(task => {
        task.addEventListener('dragstart', dragStart);
        task.addEventListener('dragend', dragEnd);
        task.addEventListener('dragover', dragOver);
        task.addEventListener('dragenter', dragEnter);
        task.addEventListener('dragleave', dragLeave);
        task.addEventListener('drop', drop);
      });

      let draggedSubtask = null;
      const subtasks = document.querySelectorAll('.subtask');
      subtasks.forEach(subtask => {
        subtask.addEventListener('dragstart', (e) => {
          draggedSubtask = e.target;
          e.target.classList.add('dragging');
        });
        subtask.addEventListener('dragend', (e) => {
          e.target.classList.remove('dragging');
          draggedSubtask = null;
        });
        subtask.addEventListener('dragover', (e) => e.preventDefault());
        subtask.addEventListener('dragenter', (e) => {
          e.preventDefault();
          if (e.target.classList.contains('subtask') && e.target !== draggedSubtask) {
            e.target.classList.add('drag-over');
          }
        });
        subtask.addEventListener('dragleave', (e) => {
          if (e.target.classList.contains('subtask')) {
            e.target.classList.remove('drag-over');
          }
        });
        subtask.addEventListener('drop', (e) => {
          e.preventDefault();
          if (draggedSubtask && e.target.classList.contains('subtask')) {
            const taskIndex = parseInt(draggedSubtask.dataset.task);
            const fromIndex = parseInt(draggedSubtask.dataset.subtask);
            const toIndex = parseInt(e.target.dataset.subtask);
            currentChild.moveSubtask(taskIndex, fromIndex, toIndex);
          }
          document.querySelectorAll('.subtask').forEach(st => st.classList.remove('drag-over'));
        });
      });

      document.querySelectorAll('.task .start, .subtask .start').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const taskIndex = parseInt(e.target.dataset.index);
          if (!isNaN(taskIndex)) currentChild.startTaskTimer(taskIndex);
          const subTaskIndex = parseInt(e.target.dataset.subtask);
          if (!isNaN(subTaskIndex)) currentChild.startSubtaskTimer(parseInt(e.target.dataset.task), subTaskIndex);
        });
      });

      document.querySelectorAll('.subtask-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', (e) => {
          const taskIndex = parseInt(e.target.dataset.task);
          const subtaskIndex = parseInt(e.target.dataset.subtask);
          currentChild.toggleSubtask(taskIndex, subtaskIndex);
        });
      });
    }

    function updateRewards() {
      if (!currentChild) return;
      currentChild.resetRewards();
      const rewardList = document.getElementById('reward-list');
      rewardList.innerHTML = '';
      currentChild.rewards.filter(reward => reward.day === currentDate).forEach((reward, index) => {
        const rewardDiv = document.createElement('div');
        rewardDiv.className = `reward-item ${reward.claimed ? 'redeemed' : ''}`;
        rewardDiv.innerHTML = `
          <span>${reward.name} (${reward.stars} ⭐)</span>
          <button ${reward.claimed ? 'disabled' : ''}>${reward.claimed ? 'Redeemed' : 'Claim'}</button>
        `;
        rewardDiv.addEventListener('click', (e) => {
          if (e.target.tagName === 'BUTTON') return;
          openEditModal('reward', index);
        });
        rewardDiv.querySelector('button').addEventListener('click', () => currentChild.claimReward(index));
        rewardList.appendChild(rewardDiv);
      });
      document.getElementById('starCount').textContent = currentChild.stars;
      updateProgressBar();
    }

    function updateProfiles() {
      const profileList = document.getElementById('profile-list');
      profileList.innerHTML = '';
      Object.keys(children).forEach(name => {
        const profileDiv = document.createElement('div');
        profileDiv.className = 'profile-item';
        const dob = children[name].dob ? new Date(children[name].dob).toLocaleDateString() : 'Not set';
        profileDiv.innerHTML = `
          <img src="${children[name].photo}" alt="${name}">
          <div class="info">
            <span>${name}</span>
            <small>DOB: ${dob}</small>
          </div>
          <div class="actions">
            <button class="edit" data-name="${name}" aria-label="Edit Profile">Edit</button>
            <button class="delete" data-name="${name}" aria-label="Delete Profile">Delete</button>
          </div>
        `;
        profileDiv.querySelector('.edit').addEventListener('click', () => editProfile(name));
        profileDiv.querySelector('.delete').addEventListener('click', () => deleteProfile(name));
        profileList.appendChild(profileDiv);
      });
    }

    let draggedTask = null;

    function dragStart(e) {
      draggedTask = e.target;
      e.target.classList.add('dragging');
    }

    function dragEnd(e) {
      e.target.classList.remove('dragging');
      draggedTask = null;
    }

    function dragOver(e) {
      e.preventDefault();
    }

    function dragEnter(e) {
      e.preventDefault();
      if (e.target.classList.contains('task') && e.target !== draggedTask) {
        e.target.classList.add('drag-over');
      }
    }

    function dragLeave(e) {
      if (e.target.classList.contains('task')) {
        e.target.classList.remove('drag-over');
      }
    }

    function drop(e) {
      e.preventDefault();
      if (draggedTask && e.target.classList.contains('task')) {
        const fromIndex = parseInt(draggedTask.dataset.index);
        const toIndex = parseInt(e.target.dataset.index);
        const temp = currentChild.tasks[fromIndex];
        currentChild.tasks[fromIndex] = currentChild.tasks[toIndex];
        currentChild.tasks[toIndex] = temp;
        currentChild.save();
        updateTasks();
      }
      document.querySelectorAll('.task').forEach(task => task.classList.remove('drag-over'));
    }

    function openModal(modalId) {
      document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId) {
      document.getElementById(modalId).style.display = 'none';
      document.getElementById('photoPreview').style.display = 'none';
      document.getElementById('taskTimer').style.display = 'none';
      document.getElementById('taskTimerCheck').checked = false;
      document.getElementById('editTimer').style.display = 'none';
      document.getElementById('editTimerCheck').checked = false;
    }

    function createSubtaskInput(name = '', timer = null) {
      const div = document.createElement('div');
      div.className = 'subtask-item';
      div.innerHTML = `
        <input type="text" class="subtask-name" placeholder="Subtask Name" value="${name}" aria-label="Subtask Name">
        <input type="number" class="subtask-timer" placeholder="Min" min="1" value="${timer || ''}" aria-label="Subtask Timer">
        <button class="delete-subtask" aria-label="Delete Subtask">X</button>
      `;
      div.querySelector('.delete-subtask').addEventListener('click', () => div.remove());
      return div;
    }

    function openEditModal(type, index) {
      editingItem = { type, index };
      const editModal = document.getElementById('edit-modal');
      const editName = document.getElementById('editName');
      const editStars = document.getElementById('editStars');
      const editDay = document.getElementById('editDay');
      const editDaily = document.getElementById('editDaily');
      const editTimerCheck = document.getElementById('editTimerCheck');
      const editTimer = document.getElementById('editTimer');
      const editCategory = document.getElementById('editCategory');
      const editSubtaskList = document.getElementById('editSubtaskList');

      if (type === 'task') {
        const task = currentChild.tasks[index];
        document.getElementById('edit-modal-title').textContent = 'Edit Task';
        editName.value = task.name;
        editStars.value = task.stars;
        editStars.style.display = 'block';
        editDay.value = task.day;
        editDaily.checked = false;
        editTimerCheck.checked = !!task.timer;
        editTimer.value = task.timer || '';
        editTimer.style.display = task.timer ? 'block' : 'none';
        editCategory.value = task.category;
        editSubtaskList.innerHTML = '';
        task.subtasks.forEach(subtask => {
          editSubtaskList.appendChild(createSubtaskInput(subtask.name, subtask.timer));
        });
      } else if (type === 'reward') {
        const reward = currentChild.rewards[index];
        document.getElementById('edit-modal-title').textContent = 'Edit Reward';
        editName.value = reward.name;
        editStars.value = reward.stars;
        editStars.style.display = 'block';
        editDay.value = reward.day;
        editDaily.checked = false;
        editTimerCheck.style.display = 'none';
        editTimer.style.display = 'none';
        editCategory.style.display = 'none';
        editSubtaskList.parentElement.style.display = 'none';
      }
      editModal.style.display = 'flex';
    }

    async function saveEdit() {
      if (!editingItem) return;
      const name = document.getElementById('editName').value.trim();
      const stars = parseInt(document.getElementById('editStars').value) || 0;
      const day = document.getElementById('editDay').value;
      const isDaily = document.getElementById('editDaily').checked;
      const useTimer = document.getElementById('editTimerCheck').checked;
      const timer = useTimer ? parseInt(document.getElementById('editTimer').value) : null;
      const category = document.getElementById('editCategory').value.trim();
      const subtasks = Array.from(document.querySelectorAll('#editSubtaskList .subtask-item')).map(item => ({
        name: item.querySelector('.subtask-name').value.trim(),
        timer: item.querySelector('.subtask-timer').value ? parseInt(item.querySelector('.subtask-timer').value) : null,
        completed: false
      })).filter(subtask => subtask.name);

      if (!name) {
        alert('Please enter a valid name.');
        return;
      }

      if (editingItem.type === 'task') {
        await currentChild.editTask(editingItem.index, name, stars, day, timer, category, subtasks);
      } else if (editingItem.type === 'reward') {
        await currentChild.editReward(editingItem.index, name, stars, day);
      }
      closeModal('edit-modal');
      editingItem = null;
    }

    async function deleteItem() {
      if (!editingItem) return;
      if (editingItem.type === 'task') await currentChild.deleteTask(editingItem.index);
      else if (editingItem.type === 'reward') await currentChild.deleteReward(editingItem.index);
      closeModal('edit-modal');
      editingItem = null;
    }

    async function saveTask() {
      if (!currentChild) {
        alert('No child selected. Please add a profile first.');
        return;
      }
      const name = document.getElementById('newTask').value.trim();
      const stars = parseInt(document.getElementById('newStars').value) || 0;
      const day = document.getElementById('taskDay').value;
      const isDaily = document.getElementById('taskDaily').checked;
      const useTimer = document.getElementById('taskTimerCheck').checked;
      const timer = useTimer ? parseInt(document.getElementById('taskTimer').value) : null;
      const category = document.getElementById('taskCategory').value.trim();
      const applyToAll = document.getElementById('applyToAllTasks').checked;
      const subtasks = Array.from(document.querySelectorAll('#subtaskList .subtask-item')).map(item => ({
        name: item.querySelector('.subtask-name').value.trim(),
        timer: item.querySelector('.subtask-timer').value ? parseInt(item.querySelector('.subtask-timer').value) : null
      })).filter(subtask => subtask.name);

      if (!name) {
        alert('Please enter a valid task name.');
        return;
      }

      const days = isDaily ? ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'] : [day];
      if (applyToAll) {
        await Promise.all(Object.values(children).map(child =>
          Promise.all(days.map(d => child.addTask(name, stars, d, timer, category, subtasks)))
        ));
      } else {
        await Promise.all(days.map(d => currentChild.addTask(name, stars, d, timer, category, subtasks)));
      }

      document.getElementById('newTask').value = '';
      document.getElementById('newStars').value = '';
      document.getElementById('taskDaily').checked = false;
      document.getElementById('taskTimerCheck').checked = false;
      document.getElementById('taskTimer').value = '';
      document.getElementById('taskCategory').value = '';
      document.getElementById('applyToAllTasks').checked = false;
      document.getElementById('subtaskList').innerHTML = '';
      document.getElementById('subtaskList').appendChild(createSubtaskInput());
      closeModal('modal');
      updateTasks();
    }

    async function saveReward() {
      if (!currentChild) {
        alert('No child selected. Please add a profile first.');
        return;
      }
      const name = document.getElementById('newRewardName').value.trim();
      const stars = parseInt(document.getElementById('newRewardStars').value);
      const day = document.getElementById('rewardDay').value;
      const isDaily = document.getElementById('rewardDaily').checked;
      const applyToAll = document.getElementById('applyToAllRewards').checked;

      if (!name || isNaN(stars) || stars <= 0) {
        alert('Please enter a valid reward name and stars.');
        return;
      }

      const days = isDaily ? ['MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT', 'SUN'] : [day];
      if (applyToAll) {
        await Promise.all(Object.values(children).map(child =>
          Promise.all(days.map(d => child.addReward(name, stars, d)))
        ));
      } else {
        await Promise.all(days.map(d => currentChild.addReward(name, stars, d)));
      }

      document.getElementById('newRewardName').value = '';
      document.getElementById('newRewardStars').value = '';
      document.getElementById('rewardDaily').checked = false;
      document.getElementById('applyToAllRewards').checked = false;
      closeModal('reward-modal');
      updateRewards();
    }

    async function saveProfile(isEdit = false) {
      const name = document.getElementById('profileName').value.trim();
      const dob = document.getElementById('profileDOB').value;
      const fileInput = document.getElementById('profilePhoto');

      if (!name) {
        alert('Profile name cannot be empty.');
        return;
      }

      if (isEdit) {
        const oldName = document.getElementById('childSelect').value;
        if (oldName !== name && children[name]) {
          alert('Profile name must be unique.');
          return;
        }
        const child = children[oldName];
        delete children[oldName];
        await db.collection('children').doc(oldName).delete();
        child.name = name;
        child.dob = dob;

        if (fileInput.files && fileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = async (e) => {
            child.photo = e.target.result;
            children[name] = child;
            if (currentChild.name === oldName) currentChild = child;
            await child.save();
            updateChildSelect();
            updateProfiles();
            closeModal('profile-modal');
            document.getElementById('app').style.display = 'block';
          };
          reader.readAsDataURL(fileInput.files[0]);
        } else {
          children[name] = child;
          if (currentChild.name === oldName) currentChild = child;
          await child.save();
          updateChildSelect();
          updateProfiles();
          closeModal('profile-modal');
          document.getElementById('app').style.display = 'block';
        }
      } else if (!children[name]) {
        const child = new Child(name);
        child.dob = dob;

        if (fileInput.files && fileInput.files[0]) {
          const reader = new FileReader();
          reader.onload = async (e) => {
            child.photo = e.target.result;
            children[name] = child;
            currentChild = child;
            await child.save();
            updateChildSelect();
            updateProfiles();
            closeModal('profile-modal');
            document.getElementById('app').style.display = 'block';
          };
          reader.readAsDataURL(fileInput.files[0]);
        } else {
          children[name] = child;
          currentChild = child;
          await child.save();
          updateChildSelect();
          updateProfiles();
          closeModal('profile-modal');
          document.getElementById('app').style.display = 'block';
        }
      } else {
        alert('Profile name must be unique.');
        return;
      }

      document.getElementById('profileName').value = '';
      document.getElementById('profileDOB').value = '';
      document.getElementById('profilePhoto').value = '';
    }

    async function editProfile(name) {
      openModal('profile-modal');
      document.getElementById('profile-modal-title').textContent = 'Edit Profile';
      document.getElementById('profileName').value = name;
      document.getElementById('profileDOB').value = children[name].dob || '';
      document.getElementById('photoPreview').src = children[name].photo;
      document.getElementById('photoPreview').style.display = 'block';
    }

    async function deleteProfile(name) {
      if (Object.keys(children).length <= 1) {
        alert('Cannot delete the last profile.');
        return;
      }
      if (confirm(`Delete profile "${name}"?`)) {
        delete children[name];
        await db.collection('children').doc(name).delete();
        if (currentChild.name === name) currentChild = children[Object.keys(children)[0]];
        updateChildSelect();
        updateProfiles();
        updateTasks();
        updateRewards();
      }
    }

    document.querySelectorAll('.date-nav span').forEach(span => {
      span.addEventListener('click', () => setDate(span.dataset.day));
    });

    document.querySelectorAll('.nav-tabs span').forEach(span => {
      span.addEventListener('click', () => showSection(span.dataset.section));
    });

    document.getElementById('add-task-btn').addEventListener('click', () => {
      openModal('modal');
      const subtaskList = document.getElementById('subtaskList');
      subtaskList.innerHTML = '';
      subtaskList.appendChild(createSubtaskInput());
    });

    document.getElementById('add-reward-btn').addEventListener('click', () => openModal('reward-modal'));
    document.getElementById('add-profile-btn').addEventListener('click', () => {
      openModal('profile-modal');
      document.getElementById('profile-modal-title').textContent = 'Add Profile';
      document.getElementById('profileName').value = '';
      document.getElementById('profileDOB').value = '';
      document.getElementById('profilePhoto').value = '';
      document.getElementById('photoPreview').style.display = 'none';
    });

    document.getElementById('save-task-btn').addEventListener('click', saveTask);
    document.getElementById('cancel-task-btn').addEventListener('click', () => closeModal('modal'));
    document.getElementById('save-reward-btn').addEventListener('click', saveReward);
    document.getElementById('cancel-reward-btn').addEventListener('click', () => closeModal('reward-modal'));
    document.getElementById('save-profile-btn').addEventListener('click', () => saveProfile(document.getElementById('profile-modal-title').textContent === 'Edit Profile'));
    document.getElementById('cancel-profile-btn').addEventListener('click', () => closeModal('profile-modal'));
    document.getElementById('create-profile-btn').addEventListener('click', () => {
      openModal('profile-modal');
      document.getElementById('profile-modal-title').textContent = 'Add Profile';
    });

    document.getElementById('save-edit-btn').addEventListener('click', saveEdit);
    document.getElementById('delete-btn').addEventListener('click', deleteItem);
    document.getElementById('cancel-edit-btn').addEventListener('click', () => closeModal('edit-modal'));

    document.getElementById('profilePhoto').addEventListener('change', (e) => {
      if (e.target.files[0]) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('photoPreview').src = e.target.result;
          document.getElementById('photoPreview').style.display = 'block';
        };
        reader.readAsDataURL(e.target.files[0]);
      }
    });

    document.getElementById('childSelect').addEventListener('change', async (e) => {
      if (e.target.value === 'edit-profiles') {
        showSection('profiles');
        document.getElementById('childSelect').value = currentChild.name;
      } else {
        currentChild = children[e.target.value] || await Child.load(e.target.value);
        updateTasks();
        updateRewards();
        updateChildSelect();
      }
    });

    document.getElementById('taskTimerCheck').addEventListener('change', function() {
      document.getElementById('taskTimer').style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('editTimerCheck').addEventListener('change', function() {
      document.getElementById('editTimer').style.display = this.checked ? 'block' : 'none';
    });

    document.getElementById('addSubtaskBtn').addEventListener('click', () => {
      document.getElementById('subtaskList').appendChild(createSubtaskInput());
    });

    document.getElementById('addEditSubtaskBtn').addEventListener('click', () => {
      document.getElementById('editSubtaskList').appendChild(createSubtaskInput());
    });

    loadInitialData();
  </script>
</body>
</html>